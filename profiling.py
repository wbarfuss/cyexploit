from cyexploit import ExploitCore as Exploit
import numpy as np
import networkx as nx
from pstats import Stats
import cProfile
from os import system
from time import time


def create_list_of_adj_mats(n_runs):
    adj_mats = []
    for i in xrange(n_runs):
        # Creating connected adj matrix
        net = nx.erdos_renyi_graph(N, link_density)
        while len(list(nx.connected_components(net))) > 1:
            print "Network has isolated components. Try again!"
            net = nx.erdos_renyi_graph(N, link_density)
        adj_mats.append(nx.adj_matrix(net).toarray())

    return adj_mats


def profiling(print_stats):
    """
    Run the model for the given set of parameters and additionally perform
    some profiling.
    """
    cProfile.runctx("sample_runs(n_runs, single_steps, N, link_density," +
                    "rewiring_prob, update_timescale, adj_mats)",
                    globals(), locals(), "profile.prof")
    s = Stats("profile.prof")
    if print_stats:
        s.strip_dirs().sort_stats("time").print_stats()
    system("rm profile.prof")


def sample_runs(n_runs, single_steps, N, link_density, rewiring_prob,
                update_timescale,
                adj_mats):
    n = 0
    n_fails = 0
    while n < n_runs:
        print "Run:", n+1

        # Agent's parameters
        MaxStocks = np.ones(N)
        Stocks = np.random.rand(N) * MaxStocks
        GrowthRates = np.ones(N)
        Rationalities = np.ones(N)
        Strategies = np.random.randint(2, size=N)

        # Running the model
        t0 = time()
        m = Exploit(adj_mats[n], Strategies, Stocks, MaxStocks, GrowthRates,
                    Rationalities, rewiring_prob, update_timescale)
        if single_steps == -1:
            fail = (m.run() == 0)
            print "Runtime: {0} min".format((time()-t0)/60.)
            if fail:
                print "No conv., in run", n+1
                n_fails += 1
            elif not fail:
                print "<sus>: {}".format(m.get_strategies().mean())
                n += 1
        else:
            m.run(steps=single_steps)
            n += 1
            print "Runtime: {0} min".format((time()-t0)/60.)

    print "Done!"


if __name__ == "__main__":

    # Defaults
    print_stats = True
    single_steps = -1       # if -1 run into consensus
    n_runs = 10             # Number of sample_runs
    N = 500                 # The number of nodes in the network
    rewiring_prob = 1.0     # The adaptive rewiring probability
    update_timescale = 1.0  # The social update time
    link_density = 0.35     # The link density of the social network

    # Special Settings
    # (n_runs, single_steps, N) = (10, 1000, 500)
    (n_runs, single_steps, N) = (5, -1, 300)
    (update_timescale, rewiring_prob) = (0.9, 0.0)

    # Do it
    adj_mats = create_list_of_adj_mats(n_runs)
    profiling(print_stats)
